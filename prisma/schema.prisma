generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ------------------------- Enums Globais -------------------------
 */

// Papel GLOBAL, para administra√ß√£o da plataforma
enum SystemRole {
  SUPERADMIN // pode criar/editar tenants e gerenciar contas
  SUPPORT // opcional, suporte limitado
  NONE // padr√£o para usu√°rios comuns
}

enum TenantRole {
  ADMIN // dono/administrador do restaurante
  MODERATOR // gerente/financeiro
  USER // atendente/gar√ßom
}

enum OrderStatus {
  OPEN
  CLOSED
  CANCELED
}

/**
 * Itens do pedido: ciclo de vida por item
 * STAGED (carrinho) -> FIRED (produzindo) -> CLOSED (fechar)| VOID (cancelar)
 */

enum OrderItemStatus {
  STAGED
  FIRED
  CLOSED
  VOID
}

enum PaymentMethod {
  CASH
  CARD
  PIX
  VOUCHER
  OTHER
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  REFUNDED
  CANCELED
}

enum PaymentTransactionType {
  AUTHORIZE
  CAPTURE
  REFUND
  CANCEL
  VOID
}

enum PaymentIntentStatus {
  OPEN
  COMPLETED
  CANCELED
}

enum PaymentAttemptStatus {
  INIT
  AUTHORIZED
  CAPTURED
  FAILED
}

enum PixChargeStatus {
  PENDING
  PAID
  EXPIRED
  CANCELED
}

enum InventoryUnit {
  ML
  L
  UNIT
}

/**
 * Mantemos seus tipos de movimento:
 * - FIRE: usar SALE com qtyDelta negativa
 * - VOID: usar ADJUSTMENT com qtyDelta positiva
 */
enum StockMovementType {
  SALE
  PURCHASE
  ADJUSTMENT
}

enum TransactionType {
  ENTRY
  EXIT
  SANGRIA
  OTHER
}

/**
 * (Opcional) roteamento de produ√ß√£o por esta√ß√£o
 */
enum PrepStation {
  KITCHEN
  BAR
  DESSERT
  OTHER
}

enum IdempotencyStatus {
  PROCESSING
  SUCCEEDED
  FAILED
  EXPIRED
}

/**
 * ------------------------- Multi-tenant -------------------------
 */

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships UserTenant[]
  categories  Category[]
  products    Product[]
  sales       Sale[]
  financials  FinancialTransaction[]

  // Orders & Estoque
  orders         Order[]
  orderItems     OrderItem[]
  payments       Payment[]
  inventoryItems InventoryItem[]
  recipes        Recipe[]
  stockMovements StockMovement[]

  // üîΩ ADI√á√ïES para fechar rela√ß√µes
  paymentIntents  PaymentIntent[]
  paymentAttempts PaymentAttempt[]
  pixCharges      PixCharge[]
}

model User {
  id         String     @id @default(uuid())
  name       String
  email      String     @unique
  password   String
  active     Boolean    @default(true)
  systemRole SystemRole @default(NONE)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  memberships           UserTenant[]
  financialTransactions FinancialTransaction[] @relation("UserFinancialTransactions")
  sales                 Sale[]

  // Rela√ß√µes com pedidos
  cashierOrders  Order[] @relation("OrderCashierUser")
  createdOrders  Order[] @relation("OrderCreatedByUser")
  assignedOrders Order[] @relation("OrderAssignedToUser")

  // Atores de VOID
  voidRequestedItems OrderItem[] @relation("VoidRequestedBy")
  voidApprovedItems  OrderItem[] @relation("VoidApprovedBy")

  // Payments
  createdPayments     Payment[]            @relation("UserCreatedPayments")
  paymentTransactions PaymentTransaction[] @relation("UserPaymentTransactions")

  // üîΩ ADI√á√ÉO: intents criados por este usu√°rio
  createdPaymentIntents PaymentIntent[] @relation("UserCreatedPaymentIntents")
}

model UserTenant {
  // v√≠nculo usu√°rio‚Üîtenant com papel no tenant
  userId   String
  tenantId String
  role     TenantRole @default(USER)

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@id([userId, tenantId]) // evita duplicidade de membership
  @@index([tenantId, role])
}

/**
 * ------------------------- Dom√≠nio (por tenant) -------------------------
 */

model Category {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  products Product[]

  @@unique([tenantId, name])
  @@index([tenantId, name])
  @@map("categories")
}

model Product {
  id          String  @id @default(uuid())
  tenantId    String
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  cost        Decimal @db.Decimal(10, 2)
  barcode     String?
  stock       Int     @default(0) // NOTA: Orders n√£o altera este campo; usa InventoryItem
  isActive    Boolean @default(true)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  saleItems  SaleItem[]
  orderItems OrderItem[]
  recipe     Recipe?

  @@unique([tenantId, name])
  @@unique([tenantId, barcode])
  @@index([tenantId, name])
  @@index([tenantId, barcode])
  @@map("products")
}

model Sale {
  id        String        @id @default(uuid())
  tenantId  String
  total     Decimal       @db.Decimal(10, 2)
  payment   PaymentMethod
  discount  Decimal?      @db.Decimal(10, 2)
  tax       Decimal?      @db.Decimal(10, 2)
  createdAt DateTime      @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  tenant Tenant     @relation(fields: [tenantId], references: [id])
  items  SaleItem[]
}

model SaleItem {
  id        String  @id @default(uuid())
  saleId    String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(10, 2)

  sale    Sale    @relation(fields: [saleId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

model FinancialTransaction {
  id          String          @id @default(uuid())
  tenantId    String
  type        TransactionType
  amount      Decimal         @db.Decimal(10, 2)
  description String?
  createdAt   DateTime        @default(now())

  createdById String
  createdBy   User   @relation("UserFinancialTransactions", fields: [createdById], references: [id])

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, type, createdAt])
}

/**
 * ------------------------- Idempot√™ncia -------------------------
 */

model IdempotencyKey {
  id                String            @id @default(uuid())
  tenantId          String
  scope             String // ex.: "orders:create"
  key               String // UUID v4 gerado pelo cliente
  status            IdempotencyStatus @default(PROCESSING)
  requestHash       String
  responseCode      Int?
  responseBody      Json?
  responseTruncated Boolean           @default(false)
  resourceType      String? // ex.: "order"
  resourceId        String? // id do recurso principal
  errorCode         String?
  errorMessage      String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  expiresAt         DateTime // TTL = now + 48h

  @@unique([tenantId, scope, key])
  @@index([tenantId, scope, key])
}

/**
 * ------------------------- Orders e Pagamentos -------------------------
 */

model Order {
  id       String      @id @default(uuid())
  tenantId String
  status   OrderStatus @default(OPEN)

  subtotal Decimal  @db.Decimal(10, 2)
  discount Decimal? @db.Decimal(10, 2)
  total    Decimal  @db.Decimal(10, 2)

  tabNumber      String?
  idempotencyKey String?
  version        Int     @default(0)

  // Atores
  createdByUserId  String
  assignedToUserId String?
  cashierUserId    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ‚úÖ NOVO: estado financeiro
  isSettled Boolean   @default(false)
  paidAt    DateTime?

  tenant         Tenant @relation(fields: [tenantId], references: [id])
  createdByUser  User   @relation("OrderCreatedByUser", fields: [createdByUserId], references: [id])
  assignedToUser User?  @relation("OrderAssignedToUser", fields: [assignedToUserId], references: [id])
  cashierUser    User?  @relation("OrderCashierUser", fields: [cashierUserId], references: [id])

  items          OrderItem[]
  payments       Payment[]
  stockMovements StockMovement[]

  // intents associados a esta ordem
  paymentIntents PaymentIntent[]

  @@unique([tenantId, idempotencyKey])
  @@index([tenantId, status, createdAt])
  @@index([tenantId, isSettled, createdAt]) // ‚úÖ NOVO
}


model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  tenantId  String
  productId String

  status  OrderItemStatus @default(STAGED)
  station PrepStation?

  quantity  Decimal @db.Decimal(10, 3)
  unitPrice Decimal @db.Decimal(10, 2)
  total     Decimal @db.Decimal(10, 2)

  notes          String?
  firedAt        DateTime?
  voidedAt       DateTime?
  voidReason     String?
  voidByUserId   String?
  voidApprovedBy String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  tenant  Tenant  @relation(fields: [tenantId], references: [id])

  // Rela√ß√µes de auditoria de VOID
  voidByUser         User? @relation("VoidRequestedBy", fields: [voidByUserId], references: [id])
  voidApprovedByUser User? @relation("VoidApprovedBy", fields: [voidApprovedBy], references: [id])

  @@index([tenantId, orderId])
}

model Payment {
  id       String @id @default(uuid())
  orderId  String
  tenantId String

  // v√≠nculo opcional a um intent aberto
  paymentIntentId String?

  method PaymentMethod
  amount Decimal       @db.Decimal(10, 2)
  status PaymentStatus // PENDING | AUTHORIZED | CAPTURED | REFUNDED | CANCELED

  provider      String?
  providerTxnId String?
  metadata      Json?

  createdByUserId String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Rela√ß√µes
  order     Order  @relation(fields: [orderId], references: [id])
  tenant    Tenant @relation(fields: [tenantId], references: [id])
  createdBy User   @relation("UserCreatedPayments", fields: [createdByUserId], references: [id])

  // rela√ß√£o com Intent
  intent PaymentIntent? @relation(fields: [paymentIntentId], references: [id])

  // üîΩ ADI√á√ÉO: tentativas (ex.: autoriza√ß√µes, callbacks do PSP)
  attempts PaymentAttempt[] @relation("Payment_Attempts")

  transactions PaymentTransaction[]

  // De-dupe robusto por evento do PSP
  @@unique([tenantId, provider, providerTxnId])
  // √çndices
  @@index([tenantId, orderId, createdAt])
  @@index([tenantId, status])
}

model PaymentIntent {
  id              String              @id @default(uuid())
  tenantId        String
  orderId         String
  currency        String              @default("BRL")
  amountDue       Decimal             @db.Decimal(10, 2)
  status          PaymentIntentStatus @default(OPEN)
  expiresAt       DateTime?
  createdByUserId String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id])
  order     Order  @relation(fields: [orderId], references: [id])
  createdBy User   @relation("UserCreatedPaymentIntents", fields: [createdByUserId], references: [id])

  payments Payment[]

  // üîΩ ADI√á√ÉO: cobran√ßas PIX geradas para este intent
  pixCharges PixCharge[] @relation("Intent_PixCharges")

  @@index([tenantId, orderId, status])
}

model PaymentAttempt {
  id            String               @id @default(uuid())
  tenantId      String
  paymentId     String
  provider      String
  providerTxnId String
  status        PaymentAttemptStatus @default(INIT)
  errorCode     String?
  errorMessage  String?
  raw           Json?
  createdAt     DateTime             @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  payment Payment @relation("Payment_Attempts", fields: [paymentId], references: [id])

  @@unique([tenantId, provider, providerTxnId])
  @@index([tenantId, paymentId, status])
  @@map("payment_attempts")
}

model WebhookEvent {
  id          String    @id @default(uuid())
  provider    String
  eventId     String    @unique
  payload     Json
  receivedAt  DateTime  @default(now())
  processedAt DateTime?

  @@map("webhook_events")
}

model PixCharge {
  id              String          @id @default(uuid())
  tenantId        String
  paymentIntentId String
  qrData          String
  emv             String?
  expiresAt       DateTime
  status          PixChargeStatus @default(PENDING)
  provider        String?
  providerTxnId   String?
  createdAt       DateTime        @default(now())

  tenant Tenant        @relation(fields: [tenantId], references: [id])
  intent PaymentIntent @relation("Intent_PixCharges", fields: [paymentIntentId], references: [id])

  @@index([tenantId, paymentIntentId, status])
  @@map("pix_charges")
}

model PaymentTransaction {
  id        String                 @id @default(uuid())
  tenantId  String
  paymentId String
  type      PaymentTransactionType
  amount    Decimal                @db.Decimal(10, 2)
  reason    String?
  byUserId  String
  createdAt DateTime               @default(now())

  // Rela√ß√µes
  payment Payment @relation(fields: [paymentId], references: [id])
  byUser  User    @relation("UserPaymentTransactions", fields: [byUserId], references: [id])

  // √çndices
  @@index([tenantId, createdAt])
  @@index([tenantId, type])
}

/**
 * ------------------------- Estoque, Receita e Movimenta√ß√£o -------------------------
 */

model InventoryItem {
  id           String        @id @default(uuid())
  tenantId     String
  name         String
  unit         InventoryUnit
  factorToBase Decimal       @db.Decimal(10, 3)
  onHand       Decimal       @db.Decimal(10, 3)
  isIngredient Boolean       @default(false)

  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  recipeLines    RecipeLine[]
  stockMovements StockMovement[]

  @@unique([tenantId, name])
}

model Recipe {
  id        String @id @default(uuid())
  productId String @unique
  tenantId  String

  product Product      @relation(fields: [productId], references: [id])
  tenant  Tenant       @relation(fields: [tenantId], references: [id])
  lines   RecipeLine[]
}

model RecipeLine {
  id              String  @id @default(uuid())
  recipeId        String
  inventoryItemId String
  qtyBase         Decimal @db.Decimal(10, 3)

  recipe        Recipe        @relation(fields: [recipeId], references: [id])
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
}

model StockMovement {
  id              String            @id @default(uuid())
  tenantId        String
  inventoryItemId String
  type            StockMovementType
  qtyDelta        Decimal           @db.Decimal(10, 3) // negativo = sa√≠da (SALE/fire); positivo = entrada (ADJUSTMENT/void)
  relatedOrderId  String?
  reason          String? // NEW: opcional para rastreabilidade
  createdAt       DateTime          @default(now())

  tenant        Tenant        @relation(fields: [tenantId], references: [id])
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  order         Order?        @relation(fields: [relatedOrderId], references: [id])

  @@index([tenantId, inventoryItemId, createdAt])
}
